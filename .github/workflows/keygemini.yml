name: "âš¡ Reset Gemini API Keys (TURBO)"

on:
  workflow_dispatch:
    inputs:
      senha:
        description: "ğŸ”’ Digite a senha para executar"
        required: true
        type: string

permissions:
  contents: write

jobs:
  reset-keys:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "ğŸ”’ Verificar senha"
        env:
          SENHA_CORRETA: ${{ secrets.SENHA }}
          SENHA_INPUT: ${{ github.event.inputs.senha }}
        run: |
          if [ "$SENHA_INPUT" != "$SENHA_CORRETA" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘   ğŸš« SENHA INCORRETA - NEGADO    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ… Senha correta"

      - name: Checkout apiss repo
        uses: actions/checkout@v4
        with:
          repository: Alisson990jd/apiss
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: "ğŸ”’ Carregar projetos protegidos (cooldown 48h)"
        shell: bash
        run: |
          USAGE_FILE="key_usage.json"

          if [ -f "$USAGE_FILE" ]; then
            NOW_EPOCH=$(date -u +%s)
            COOLDOWN_SECS=$((48 * 3600))

            python3 - "$USAGE_FILE" "$NOW_EPOCH" "$COOLDOWN_SECS" <<'PYPROT'
          import json, sys

          usage_file = sys.argv[1]
          now_epoch = int(sys.argv[2])
          cooldown_secs = int(sys.argv[3])

          try:
              with open(usage_file, 'r') as f:
                  data = json.load(f)
          except:
              data = {"used_keys": [], "expired_keys": []}

          protected_projects = set()

          for entry in data.get('used_keys', []):
              ts = entry.get('timestamp', 0)
              if now_epoch - ts < cooldown_secs:
                  proj = entry.get('project', '')
                  if proj:
                      protected_projects.add(proj)

          for entry in data.get('expired_keys', []):
              ts = entry.get('timestamp', 0)
              if now_epoch - ts < cooldown_secs:
                  proj = entry.get('project', '')
                  if proj:
                      protected_projects.add(proj)

          with open('/tmp/protected_projects.txt', 'w') as f:
              for p in protected_projects:
                  f.write(p + '\n')

          print(f"ğŸ”’ {len(protected_projects)} projetos protegidos (cooldown 48h)")
          for p in sorted(protected_projects):
              print(f"   ğŸ›¡ï¸ {p}")
          PYPROT

          else
            echo "â„¹ï¸ Sem arquivo de uso - nenhuma proteÃ§Ã£o ativa"
            touch /tmp/protected_projects.txt
          fi

      - name: "âš¡ Reset Keys - 20 Workers"
        shell: bash
        run: |
          set +e

          MAX_WORKERS=20
          W="$( mktemp -d )"
          mkdir -p "$W"/{results,keys,logs,queue}

          cat > "$W/worker.sh" <<'WRK'
          #!/bin/bash
          set +e
          TOKEN="$1"; PROJECT="$2"; RESULT="$3"; KEYF="$4"; ACCOUNT="$5"; PROTECTED_FILE="$6"

          # VERIFICAR SE PROJETO ESTÃ PROTEGIDO
          if [ -f "$PROTECTED_FILE" ] && [ -s "$PROTECTED_FILE" ]; then
            if grep -qxF "$PROJECT" "$PROTECTED_FILE" 2>/dev/null; then
              # Projeto protegido - nÃ£o mexer
              # Pegar a key existente para manter no arquivo
              curl -sS -m10 -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
                "https://serviceusage.googleapis.com/v1/projects/${PROJECT}/services/apikeys.googleapis.com:enable" -d'{}' &>/dev/null
              sleep 2

              EXISTING_KEY=""
              KEYS_JSON=$(curl -sS -m15 -H "Authorization: Bearer $TOKEN" \
                "https://apikeys.googleapis.com/v2/projects/${PROJECT}/locations/global/keys?pageSize=1" 2>/dev/null)
              FIRST_KEY=$(echo "$KEYS_JSON" | jq -r '.keys[0]?.name // empty')
              if [ -n "$FIRST_KEY" ]; then
                EXISTING_KEY=$(curl -sS -m10 -H "Authorization: Bearer $TOKEN" \
                  "https://apikeys.googleapis.com/v2/${FIRST_KEY}/keyString" 2>/dev/null \
                  | jq -r '.keyString // empty')
              fi

              echo "${ACCOUNT}|${PROJECT}|PROTECTED|0" > "$RESULT"
              if [ -n "$EXISTING_KEY" ]; then
                echo "$EXISTING_KEY" > "$KEYF"
              fi
              exit 0
            fi
          fi

          # PROJETO NÃƒO PROTEGIDO - PROCESSAR NORMALMENTE
          curl -sS -m10 -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://serviceusage.googleapis.com/v1/projects/${PROJECT}/services/apikeys.googleapis.com:enable" -d'{}' &>/dev/null &
          curl -sS -m10 -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://serviceusage.googleapis.com/v1/projects/${PROJECT}/services/generativelanguage.googleapis.com:enable" -d'{}' &>/dev/null &
          wait
          sleep 3

          KEYS=$(curl -sS -m15 -H "Authorization: Bearer $TOKEN" \
            "https://apikeys.googleapis.com/v2/projects/${PROJECT}/locations/global/keys?pageSize=500" 2>/dev/null \
            | jq -r '.keys[]?.name // empty')

          DEL=0
          if [ -n "$KEYS" ]; then
            while IFS= read -r K; do
              [ -z "$K" ] && continue
              curl -sS -m10 -X DELETE -H "Authorization: Bearer $TOKEN" \
                "https://apikeys.googleapis.com/v2/${K}" &>/dev/null &
              DEL=$((DEL+1))
            done <<< "$KEYS"
            wait
            sleep 2
          fi

          RESP=$(curl -sS -m20 -X POST \
            -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://apikeys.googleapis.com/v2/projects/${PROJECT}/locations/global/keys" \
            -d "{\"displayName\":\"gemini-$(date +%s)-$RANDOM\",\"restrictions\":{\"apiTargets\":[{\"service\":\"generativelanguage.googleapis.com\"}]}}" 2>/dev/null)

          OP=$(echo "$RESP" | jq -r '.name // empty')

          API_KEY=""
          if [ -n "$OP" ]; then
            for i in $(seq 1 15); do
              sleep 2
              R=$(curl -sS -m10 -H "Authorization: Bearer $TOKEN" \
                "https://apikeys.googleapis.com/v2/${OP}" 2>/dev/null)
              DONE=$(echo "$R" | jq -r '.done // false')
              if [ "$DONE" = "true" ]; then
                KR=$(echo "$R" | jq -r '.response.name // empty')
                if [ -n "$KR" ]; then
                  sleep 1
                  API_KEY=$(curl -sS -m10 -H "Authorization: Bearer $TOKEN" \
                    "https://apikeys.googleapis.com/v2/${KR}/keyString" 2>/dev/null \
                    | jq -r '.keyString // empty')
                fi
                break
              fi
            done
          fi

          if [ -n "$API_KEY" ]; then
            echo "${ACCOUNT}|${PROJECT}|${API_KEY}|${DEL}" > "$RESULT"
            echo "$API_KEY" > "$KEYF"
          else
            echo "${ACCOUNT}|${PROJECT}|ERRO|${DEL}" > "$RESULT"
          fi
          WRK
          chmod +x "$W/worker.sh"

          if [ ! -d "tokens" ]; then
            echo "âŒ Pasta tokens/ nÃ£o encontrada"; ls -la; exit 1
          fi

          echo "âš¡ TURBO MODE - $MAX_WORKERS workers paralelos"
          echo ""

          TASK=0
          ACCT=0

          for TF in tokens/*.json; do
            [ ! -f "$TF" ] && continue
            ACCOUNT=$(basename "$TF" .json)
            ACCT=$((ACCT+1))

            RT=$(jq -r '.refresh_token//empty' "$TF")
            CI=$(jq -r '.client_id//empty' "$TF")
            CS=$(jq -r '.client_secret//empty' "$TF")
            TU=$(jq -r '.token_uri//"https://oauth2.googleapis.com/token"' "$TF")

            [ -z "$RT" ] || [ -z "$CI" ] || [ -z "$CS" ] && echo "âš ï¸ Skip $ACCOUNT" && continue

            AT=$(curl -sS -m15 -X POST "$TU" \
              -d "client_id=${CI}&client_secret=${CS}&refresh_token=${RT}&grant_type=refresh_token" 2>/dev/null \
              | jq -r '.access_token//empty')

            [ -z "$AT" ] && echo "âŒ Auth falhou: $ACCOUNT" && continue
            echo "âœ… [$ACCT] $ACCOUNT"

            echo "$AT" > "$W/${ACCOUNT}.tok"

            PT=""
            URL="https://cloudresourcemanager.googleapis.com/v1/projects?filter=lifecycleState%3AACTIVE&pageSize=500"
            while true; do
              [ -n "$PT" ] && FURL="${URL}&pageToken=${PT}" || FURL="$URL"
              PR=$(curl -sS -m15 -H "Authorization: Bearer $AT" "$FURL" 2>/dev/null)
              PP=$(echo "$PR" | jq -r '.projects[]?.projectId//empty')
              [ -n "$PP" ] && while IFS= read -r P; do
                [ -z "$P" ] && continue
                TASK=$((TASK+1))
                echo "${ACCOUNT}|${P}" > "$W/queue/t_${TASK}"
              done <<< "$PP"
              PT=$(echo "$PR" | jq -r '.nextPageToken//empty')
              [ -z "$PT" ] && break
            done
          done

          echo ""
          echo "ğŸ“‹ Total: $TASK projetos | $MAX_WORKERS workers"
          PROT_COUNT=$(wc -l < /tmp/protected_projects.txt 2>/dev/null || echo "0")
          echo "ğŸ”’ Projetos protegidos: $PROT_COUNT"
          echo ""

          [ "$TASK" -eq 0 ] && echo "Nenhum projeto" && echo "vazio" > gemini_keys.txt && > gemini_keys_only.txt && exit 0

          RUNNING=0
          DONE_COUNT=0
          declare -A PIDS

          for TF in $(ls "$W/queue/" | sort -V); do
            DATA=$(cat "$W/queue/$TF")
            A=$(echo "$DATA" | cut -d'|' -f1)
            P=$(echo "$DATA" | cut -d'|' -f2)
            T=$(cat "$W/${A}.tok")
            N=$(echo "$TF" | sed 's/t_//')

            while [ $RUNNING -ge $MAX_WORKERS ]; do
              for pid in "${!PIDS[@]}"; do
                if ! kill -0 "$pid" 2>/dev/null; then
                  wait "$pid" 2>/dev/null
                  unset PIDS[$pid]
                  RUNNING=$((RUNNING-1))
                  DONE_COUNT=$((DONE_COUNT+1))
                fi
              done
              [ $RUNNING -ge $MAX_WORKERS ] && sleep 0.5
            done

            bash "$W/worker.sh" "$T" "$P" "$W/results/r_${N}" "$W/keys/k_${N}" "$A" "/tmp/protected_projects.txt" &
            PIDS[$!]=1
            RUNNING=$((RUNNING+1))

            if [ $((DONE_COUNT % 10)) -eq 0 ] && [ $DONE_COUNT -gt 0 ]; then
              echo "  âš¡ $DONE_COUNT/$TASK concluÃ­dos ($RUNNING ativos)"
            fi
          done

          for pid in "${!PIDS[@]}"; do
            wait "$pid" 2>/dev/null
            DONE_COUNT=$((DONE_COUNT+1))
          done

          echo "âœ… $DONE_COUNT/$TASK processados!"
          echo ""

          CREATED=0; DELETED=0; ERRORS=0; PROTECTED=0

          cat > gemini_keys.txt <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      âš¡ GEMINI API KEYS - TURBO GENERATED âš¡     â•‘
          â•‘   $(date -u '+%Y-%m-%d %H:%M:%S UTC')                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          EOF

          > gemini_keys_only.txt

          # Gerar mapeamento key -> projeto
          > key_project_map.json
          echo '{' > key_project_map.json

          CUR=""
          FIRST_MAP=true
          for R in $(find "$W/results" -name "r_*" | sort -V); do
            L=$(cat "$R")
            RA=$(echo "$L"|cut -d'|' -f1)
            RP=$(echo "$L"|cut -d'|' -f2)
            RK=$(echo "$L"|cut -d'|' -f3)
            RD=$(echo "$L"|cut -d'|' -f4)

            if [ "$RK" = "PROTECTED" ]; then
              PROTECTED=$((PROTECTED+1))
              if [ "$RA" != "$CUR" ]; then
                CUR="$RA"
                echo -e "\nğŸ“§ $RA\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> gemini_keys.txt
              fi
              echo "  $RP = ğŸ”’ PROTEGIDA (cooldown 48h)" >> gemini_keys.txt
              continue
            fi

            DELETED=$((DELETED + RD))

            if [ "$RA" != "$CUR" ]; then
              CUR="$RA"
              echo -e "\nğŸ“§ $RA\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> gemini_keys.txt
            fi

            if [ "$RK" != "ERRO" ] && [ -n "$RK" ]; then
              echo "  $RP = $RK" >> gemini_keys.txt
              echo "$RK" >> gemini_keys_only.txt
              CREATED=$((CREATED+1))
            else
              echo "  $RP = âŒ ERRO" >> gemini_keys.txt
              ERRORS=$((ERRORS+1))
            fi
          done

          for KF in "$W/keys"/k_*; do
            [ ! -s "$KF" ] && continue
            KV=$(cat "$KF")
            grep -qF "$KV" gemini_keys_only.txt 2>/dev/null || echo "$KV" >> gemini_keys_only.txt
          done

          # Gerar key_project_map.json corretamente
          python3 - "$W/results" <<'PYMAP'
          import json, os, sys, glob

          results_dir = sys.argv[1]
          mapping = {}

          for rf in sorted(glob.glob(os.path.join(results_dir, "r_*"))):
              with open(rf, 'r') as f:
                  line = f.read().strip()
              parts = line.split('|')
              if len(parts) >= 3:
                  account = parts[0]
                  project = parts[1]
                  key = parts[2]
                  if key not in ('ERRO', 'PROTECTED', ''):
                      mapping[key] = {
                          "project": project,
                          "account": account
                      }

          with open('key_project_map.json', 'w') as f:
              json.dump(mapping, f, indent=2)

          print(f"ğŸ“ Mapeamento: {len(mapping)} keys -> projetos")
          PYMAP

          TOTAL_KEYS=$(wc -l < gemini_keys_only.txt)

          {
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  Contas:      $ACCT"
            echo "  Projetos:    $TASK"
            echo "  Deletadas:   $DELETED"
            echo "  Criadas:     $CREATED"
            echo "  Protegidas:  $PROTECTED"
            echo "  Erros:       $ERRORS"
            echo "  Workers:     $MAX_WORKERS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          } | tee -a gemini_keys.txt

          echo ""
          echo "ğŸ”‘ $TOTAL_KEYS keys geradas"
          echo "ğŸ”’ $PROTECTED projetos protegidos (cooldown 48h)"

          rm -rf "$W"

      - name: Commit & Push
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git add gemini_keys.txt gemini_keys_only.txt key_project_map.json
          git diff --cached --quiet && echo "Sem mudanÃ§as" && exit 0
          K=$(wc -l < gemini_keys_only.txt)
          git commit -m "âš¡ $K keys - $(date -u '+%H:%M UTC')"
          git push
