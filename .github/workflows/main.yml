name: Bot CÃ­clico - ExecuÃ§Ã£o a cada 12h

on:
  schedule:
    # Executa a cada 12 horas (00:00 e 12:00 UTC)
    - cron: '0 */12 * * *'
  
  workflow_dispatch:
    # Permite execuÃ§Ã£o manual
    inputs:
      duracao_horas:
        description: 'DuraÃ§Ã£o da execuÃ§Ã£o em horas'
        required: false
        default: '11'
        type: string

env:
  REPO_OWNER: Alisson990jd
  REPO_NAME: apiss
  BOT_ZIP: bot.zip
  BOT_BRANCH: main  # ou master, dependendo da sua branch principal

jobs:
  executar-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 horas de timeout mÃ¡ximo
    
    steps:
      - name: ğŸ“‹ Configurar Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: ğŸ”§ Instalar DependÃªncias do Sistema
        run: |
          echo "ğŸ“„ Atualizando repositÃ³rios..."
          sudo apt-get update -qq
          
          echo "ğŸ“¦ Instalando FFmpeg..."
          sudo apt-get install -y -qq ffmpeg
          
          echo "ğŸ“¦ Instalando Python 3 e pip..."
          sudo apt-get install -y -qq python3 python3-pip python3-venv
          
          echo "ğŸ“¦ Instalando unzip..."
          sudo apt-get install -y -qq unzip curl wget
          
          echo "âœ… DependÃªncias do sistema instaladas com sucesso!"
      
      - name: ğŸ”§ Instalar yt-dlp
        run: |
          echo "ğŸ“¦ Instalando yt-dlp..."
          sudo wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version
          echo "âœ… yt-dlp instalado com sucesso!"
      
      - name: ğŸ”§ Instalar rclone
        run: |
          echo "ğŸ“¦ Instalando rclone..."
          curl https://rclone.org/install.sh | sudo bash
          rclone version
          echo "âœ… rclone instalado com sucesso!"
      
      - name: ğŸ“¥ Baixar bot.zip do repositÃ³rio
        env:
          GH_TOKEN: ${{ secrets.GHTOKEN }}
        run: |
          echo "ğŸ“¥ Baixando bot.zip do repositÃ³rio..."
          
          # Usar as variÃ¡veis de ambiente do repositÃ³rio
          OWNER="$REPO_OWNER"
          REPO="$REPO_NAME"
          FILE="bot.zip"
          
          echo "ğŸ“¦ RepositÃ³rio: $OWNER/$REPO"
          echo "ğŸ“„ Arquivo: $FILE"
          
          # MÃ©todo 1: Tentar download direto via raw.githubusercontent.com
          echo ""
          echo "ğŸ“„ MÃ©todo 1: Download direto (raw.githubusercontent.com)..."
          
          # Tentar branch main
          RAW_URL="https://raw.githubusercontent.com/$OWNER/$REPO/main/$FILE"
          echo "ğŸ”— Tentando: $RAW_URL"
          
          HTTP_CODE=$(curl -L -w "%{http_code}" -s \
            -H "Authorization: token $GH_TOKEN" \
            "$RAW_URL" \
            -o bot.zip)
          
          echo "ğŸ“¡ HTTP Status: $HTTP_CODE"
          
          # Se falhar, tentar branch master
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸ Falhou na branch main, tentando master..."
            RAW_URL="https://raw.githubusercontent.com/$OWNER/$REPO/master/$FILE"
            echo "ğŸ”— Tentando: $RAW_URL"
            
            HTTP_CODE=$(curl -L -w "%{http_code}" -s \
              -H "Authorization: token $GH_TOKEN" \
              "$RAW_URL" \
              -o bot.zip)
            
            echo "ğŸ“¡ HTTP Status: $HTTP_CODE"
          fi
          
          # Verificar se o arquivo foi baixado corretamente
          if [ -f bot.zip ]; then
            BOT_SIZE=$(stat -c%s bot.zip 2>/dev/null || stat -f%z bot.zip 2>/dev/null)
            echo "ğŸ“Š Tamanho: $BOT_SIZE bytes"
            
            # Verificar se Ã© um ZIP vÃ¡lido
            if file bot.zip | grep -q "Zip archive"; then
              echo "âœ… MÃ©todo 1 bem-sucedido!"
            else
              echo "âš ï¸ MÃ©todo 1 baixou arquivo invÃ¡lido, tentando mÃ©todo 2..."
              rm -f bot.zip
              HTTP_CODE="000"
            fi
          fi
          
          # MÃ©todo 2: Download via GitHub API
          if [ "$HTTP_CODE" != "200" ]; then
            echo ""
            echo "ğŸ“„ MÃ©todo 2: Download via API do GitHub..."
            
            # Tentar branch main
            API_URL="https://api.github.com/repos/$OWNER/$REPO/contents/$FILE"
            echo "ğŸ”— Tentando: $API_URL"
            
            RESPONSE=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "$API_URL")
            
            # Verificar se obteve resposta vÃ¡lida
            if echo "$RESPONSE" | python3 -c "import sys, json; json.load(sys.stdin)" 2>/dev/null; then
              echo "ğŸ“¦ Decodificando conteÃºdo base64..."
              echo "$RESPONSE" | python3 -c "
import sys, json, base64
try:
    data = json.load(sys.stdin)
    if 'content' in data:
        content = base64.b64decode(data['content'])
        with open('bot.zip', 'wb') as f:
            f.write(content)
        print('âœ… Arquivo decodificado com sucesso!')
    else:
        print('âŒ Resposta da API nÃ£o contÃ©m campo content')
        print('Resposta:', json.dumps(data, indent=2)[:500])
        sys.exit(1)
except Exception as e:
    print(f'âŒ Erro ao processar resposta: {e}')
    sys.exit(1)
"
              
              if [ $? -eq 0 ] && [ -f bot.zip ]; then
                BOT_SIZE=$(stat -c%s bot.zip 2>/dev/null || stat -f%z bot.zip 2>/dev/null)
                echo "ğŸ“Š Tamanho: $BOT_SIZE bytes"
                
                if file bot.zip | grep -q "Zip archive"; then
                  echo "âœ… MÃ©todo 2 bem-sucedido!"
                else
                  echo "âŒ MÃ©todo 2 baixou arquivo invÃ¡lido"
                fi
              fi
            else
              echo "âŒ Resposta da API invÃ¡lida"
              echo "Resposta: ${RESPONSE:0:500}"
            fi
          fi
          
          # VerificaÃ§Ã£o final
          echo ""
          echo "ğŸ” VerificaÃ§Ã£o final..."
          
          if [ ! -f bot.zip ]; then
            echo "âŒ ERRO: bot.zip nÃ£o foi baixado!"
            echo ""
            echo "ğŸ’¡ PossÃ­veis soluÃ§Ãµes:"
            echo "   1. Verifique se o arquivo bot.zip existe no repositÃ³rio $OWNER/$REPO"
            echo "   2. Verifique se o token GHTOKEN tem permissÃµes de leitura"
            echo "   3. Verifique se o arquivo estÃ¡ na branch main ou master"
            echo ""
            echo "ğŸ”— Verifique manualmente em:"
            echo "   https://github.com/$OWNER/$REPO/blob/main/bot.zip"
            exit 1
          fi
          
          BOT_SIZE=$(stat -c%s bot.zip 2>/dev/null || stat -f%z bot.zip 2>/dev/null)
          echo "ğŸ“Š Tamanho final: $BOT_SIZE bytes ($(echo "scale=2; $BOT_SIZE / 1024 / 1024" | bc 2>/dev/null || echo "?") MB)"
          
          # Verificar tipo do arquivo
          echo "ğŸ” Tipo do arquivo:"
          file bot.zip
          
          # Verificar se Ã© HTML (erro 404)
          if file bot.zip | grep -q "HTML"; then
            echo "âŒ ERRO: O arquivo baixado Ã© HTML (provavelmente pÃ¡gina de erro 404)"
            echo "ğŸ“„ Primeiros 200 caracteres:"
            head -c 200 bot.zip
            exit 1
          fi
          
          # Verificar se Ã© realmente um ZIP
          if ! file bot.zip | grep -q "Zip archive"; then
            echo "âŒ ERRO: O arquivo nÃ£o Ã© um ZIP vÃ¡lido!"
            echo "ğŸ“„ Primeiros bytes (hex):"
            hexdump -C bot.zip | head -5
            exit 1
          fi
          
          # Testar integridade do ZIP
          echo "ğŸ§ª Testando integridade..."
          if unzip -t bot.zip >/dev/null 2>&1; then
            echo "âœ… bot.zip Ã© vÃ¡lido e Ã­ntegro!"
          else
            echo "âŒ ERRO: bot.zip estÃ¡ corrompido!"
            unzip -t bot.zip
            exit 1
          fi
          
          echo ""
          echo "âœ… bot.zip baixado e verificado com sucesso!"
      
      - name: ğŸ“‚ Extrair bot.zip
        run: |
          echo "ğŸ“‚ Extraindo bot.zip..."
          
          # Verificar novamente se bot.zip existe
          if [ ! -f bot.zip ]; then
            echo "âŒ Erro: bot.zip nÃ£o encontrado!"
            ls -la
            exit 1
          fi
          
          # Verificar tipo antes de extrair
          echo "ğŸ” Verificando tipo do arquivo:"
          file bot.zip
          
          # Criar diretÃ³rio de trabalho
          mkdir -p bot_workspace
          
          # Extrair bot.zip com verbose
          echo "ğŸ“¦ Extraindo arquivos..."
          if unzip -q bot.zip -d bot_workspace; then
            echo "âœ… ExtraÃ§Ã£o bem-sucedida!"
          else
            echo "âŒ Erro ao extrair bot.zip!"
            echo "ğŸ“Š InformaÃ§Ãµes do arquivo:"
            ls -lh bot.zip
            file bot.zip
            echo "ğŸ“„ Tentando listar conteÃºdo do ZIP:"
            unzip -l bot.zip || true
            exit 1
          fi
          
          # Verificar se a extraÃ§Ã£o foi bem-sucedida
          if [ ! -d bot_workspace ]; then
            echo "âŒ Erro: DiretÃ³rio bot_workspace nÃ£o foi criado!"
            exit 1
          fi
          
          # Verificar se hÃ¡ arquivos no diretÃ³rio
          FILE_COUNT=$(find bot_workspace -type f | wc -l)
          echo "ğŸ“Š Arquivos extraÃ­dos: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ ATENÃ‡ÃƒO: Nenhum arquivo foi extraÃ­do!"
            exit 1
          fi
          
          # Listar arquivos extraÃ­dos
          echo "ğŸ“‹ Arquivos extraÃ­dos:"
          ls -lah bot_workspace/
          
          echo "âœ… bot.zip extraÃ­do com sucesso!"
      
      - name: ğŸ Instalar DependÃªncias Python
        run: |
          echo "ğŸ Instalando dependÃªncias Python..."
          
          cd bot_workspace
          
          # Atualizar pip
          python3 -m pip install --upgrade pip
          
          # Instalar todas as dependÃªncias
          echo "ğŸ“¦ Instalando pacotes Python..."
          python3 -m pip install --upgrade \
            discord.py \
            aiohttp \
            python-dateutil \
            kickapi \
            requests \
            packaging \
            google-auth-oauthlib \
            google-auth \
            google-api-python-client \
            google-cloud-resource-manager \
            google-cloud-service-usage \
            google-cloud-api-keys \
            google-generativeai \
            protobuf \
            cachetools \
            pyasn1 \
            pyasn1-modules \
            rsa \
            streamlink
          
          echo "âœ… DependÃªncias Python instaladas com sucesso!"
      
      - name: ğŸ” Verificar Arquivos NecessÃ¡rios
        run: |
          echo "ğŸ” Verificando arquivos necessÃ¡rios..."
          
          cd bot_workspace
          
          # Verificar se start.py existe
          if [ ! -f start.py ]; then
            echo "âŒ Erro: start.py nÃ£o encontrado!"
            exit 1
          fi
          
          # Verificar se dc.py existe
          if [ ! -f dc.py ]; then
            echo "âŒ Erro: dc.py nÃ£o encontrado!"
            exit 1
          fi
          
          # Listar arquivos .json
          echo "ğŸ“„ Arquivos JSON encontrados:"
          ls -lah *.json 2>/dev/null || echo "Nenhum arquivo JSON encontrado"
          
          echo "âœ… Arquivos verificados com sucesso!"
      
      - name: ğŸš€ Executar start.py
        id: executar_bot
        env:
          DURACAO_HORAS: ${{ github.event.inputs.duracao_horas || '11' }}
        run: |
          echo "ğŸš€ Iniciando start.py..."
          echo "â±ï¸ DuraÃ§Ã£o configurada: $DURACAO_HORAS horas"
          
          cd bot_workspace
          
          # Calcular tempo em segundos (11 horas = 39600 segundos)
          DURACAO_SEGUNDOS=$((DURACAO_HORAS * 3600))
          echo "â±ï¸ DuraÃ§Ã£o em segundos: $DURACAO_SEGUNDOS"
          
          # Criar script de execuÃ§Ã£o com timeout
          cat > run_with_timeout.sh << EOF
          #!/bin/bash

          DURACAO=\$1
          LOG_FILE="bot_execution.log"

          echo "ğŸ¬ Iniciando execuÃ§Ã£o do bot..."
          echo "â±ï¸ Tempo mÃ¡ximo: $DURACAO segundos"
          echo "ğŸ“ Log serÃ¡ salvo em: $LOG_FILE"

          # Executar start.py em background e capturar PID
          python3 -u start.py > "$LOG_FILE" 2>&1 &
          BOT_PID=$!

          echo "âœ… Bot iniciado com PID: $BOT_PID"
          echo "â³ Aguardando $DURACAO segundos..."

          # Aguardar pela duraÃ§Ã£o especificada
          sleep $DURACAO

          # Verificar se o processo ainda estÃ¡ rodando
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "â„¹ï¸ Tempo esgotado. Parando o bot..."
            
            # Enviar SIGTERM (interrupÃ§Ã£o graceful)
            kill -TERM $BOT_PID 2>/dev/null
            
            # Aguardar atÃ© 30 segundos para o processo terminar
            for i in {1..30}; do
              if ! kill -0 $BOT_PID 2>/dev/null; then
                echo "âœ… Bot parado gracefully"
                exit 0
              fi
              sleep 1
            done
            
            # Se ainda estiver rodando, forÃ§ar
            if kill -0 $BOT_PID 2>/dev/null; then
              echo "âš ï¸ Processo nÃ£o respondeu, forÃ§ando encerramento..."
              kill -KILL $BOT_PID 2>/dev/null
            fi
            
            echo "âœ… Bot parado (forcefully)"
          else
            echo "â„¹ï¸ Bot jÃ¡ finalizou antes do timeout"
          fi

          # Exibir Ãºltimas linhas do log
          echo ""
          echo "ğŸ“‹ Ãšltimas 50 linhas do log:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          tail -n 50 "$LOG_FILE"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          exit 0
          SCRIPT_EOF
          
          chmod +x run_with_timeout.sh
          
          # Executar o script
          ./run_with_timeout.sh $DURACAO_SEGUNDOS
          
          echo "âœ… ExecuÃ§Ã£o do bot concluÃ­da!"
      
      - name: ğŸ“Š Exibir EstatÃ­sticas de ExecuÃ§Ã£o
        if: always()
        run: |
          echo "ğŸ“Š EstatÃ­sticas de ExecuÃ§Ã£o"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          cd bot_workspace
          
          # Verificar se data.json existe e mostrar estatÃ­sticas
          if [ -f data.json ]; then
            echo "ğŸ“„ data.json encontrado!"
            
            # Contar streamers
            STREAMERS=$(python3 -c "import json; data=json.load(open('data.json')); print(len(data.get('streamers', {})))" 2>/dev/null || echo "0")
            echo "ğŸ‘¥ Streamers monitorados: $STREAMERS"
            
            # Contar VODs processados
            VODS=$(python3 -c "import json; data=json.load(open('data.json')); print(len(data.get('processed_vods', {})))" 2>/dev/null || echo "0")
            echo "ğŸ¬ VODs processados: $VODS"
          else
            echo "âš ï¸ data.json nÃ£o encontrado"
          fi
          
          # Mostrar espaÃ§o em disco usado
          echo ""
          echo "ğŸ’¾ EspaÃ§o em disco usado:"
          du -sh . 2>/dev/null || echo "NÃ£o foi possÃ­vel calcular"
          
          # Listar arquivos grandes
          echo ""
          echo "ğŸ“¦ Arquivos maiores que 10MB:"
          find . -type f -size +10M -exec ls -lh {} \; 2>/dev/null || echo "Nenhum arquivo grande encontrado"
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      
      - name: ğŸ—œï¸ Compactar bot_workspace
        if: always()
        run: |
          echo "ğŸ—œï¸ Compactando bot_workspace..."
          
          # Remover bot.zip antigo
          rm -f bot.zip
          
          # Compactar todo o diretÃ³rio bot_workspace
          cd bot_workspace
          zip -r -q ../bot.zip .
          cd ..
          
          # Verificar tamanho do novo bot.zip
          NEW_SIZE=$(stat -f%z bot.zip 2>/dev/null || stat -c%s bot.zip 2>/dev/null)
          echo "ğŸ“Š Tamanho do novo bot.zip: $NEW_SIZE bytes"
          
          # Converter para MB
          SIZE_MB=$(echo "scale=2; $NEW_SIZE / 1024 / 1024" | bc)
          echo "ğŸ“Š Tamanho em MB: ${SIZE_MB}MB"
          
          echo "âœ… bot_workspace compactado com sucesso!"
      
      - name: ğŸ“¤ Fazer Upload do novo bot.zip para o repositÃ³rio
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GHTOKEN }}
        run: |
          echo "ğŸ“¤ Fazendo upload do novo bot.zip..."
          
          # Codificar bot.zip em base64
          BASE64_CONTENT=$(base64 -w 0 bot.zip)
          
          # Obter SHA do arquivo atual
          echo "ğŸ” Obtendo SHA do arquivo atual..."
          SHA_RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/contents/$BOT_ZIP")
          
          SHA=$(echo "$SHA_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('sha', ''))")
          
          if [ -z "$SHA" ]; then
            echo "âš ï¸ Arquivo nÃ£o existe no repositÃ³rio, criando novo..."
            MESSAGE="ğŸ¤– Bot atualizado automaticamente - $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
            
            # Criar arquivo
            curl -X PUT \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/contents/$BOT_ZIP" \
              -d "{\"message\":\"$MESSAGE\",\"content\":\"$BASE64_CONTENT\"}"
          else
            echo "âœ… SHA obtido: ${SHA:0:7}..."
            MESSAGE="ğŸ“„ Bot atualizado automaticamente - $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
            
            # Atualizar arquivo
            curl -X PUT \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/contents/$BOT_ZIP" \
              -d "{\"message\":\"$MESSAGE\",\"content\":\"$BASE64_CONTENT\",\"sha\":\"$SHA\"}"
          fi
          
          echo "âœ… Upload concluÃ­do!"
      
      - name: ğŸ“‹ Resumo da ExecuÃ§Ã£o
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "ğŸ“‹ RESUMO DA EXECUÃ‡ÃƒO"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Data/Hora: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "â±ï¸ DuraÃ§Ã£o configurada: ${{ github.event.inputs.duracao_horas || '11' }} horas"
          echo "ğŸ”„ PrÃ³xima execuÃ§Ã£o: Em ~12 horas"
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "âœ… Workflow concluÃ­do com sucesso!"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ§¹ Limpeza de Arquivos TemporÃ¡rios
        if: always()
        run: |
          echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
          
          # Remover diretÃ³rio de trabalho
          rm -rf bot_workspace
          
          # Remover bot.zip local
          rm -f bot.zip
          
          echo "âœ… Limpeza concluÃ­da!"
