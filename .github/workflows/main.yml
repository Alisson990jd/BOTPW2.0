name: "âš¡ Reset Gemini API Keys (TURBO)"

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  reset-keys:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout apiss repo
        uses: actions/checkout@v4
        with:
          repository: Alisson990jd/apiss
          token: ${{ secrets.GH_PAT }}
          ref: main

      - name: "âš¡ Reset Keys - 20 Workers"
        shell: bash
        run: |
          set +e

          MAX_WORKERS=20
          W="$( mktemp -d )"
          mkdir -p "$W"/{results,keys,logs,queue}

          # â”€â”€ FunÃ§Ãµes no script do worker â”€â”€
          cat > "$W/worker.sh" <<'WRK'
          #!/bin/bash
          set +e
          TOKEN="$1"; PROJECT="$2"; RESULT="$3"; KEYF="$4"; ACCOUNT="$5"

          # Habilitar APIs (fire-and-forget, sem esperar)
          curl -sS -m10 -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://serviceusage.googleapis.com/v1/projects/${PROJECT}/services/apikeys.googleapis.com:enable" -d'{}' &>/dev/null &
          curl -sS -m10 -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://serviceusage.googleapis.com/v1/projects/${PROJECT}/services/generativelanguage.googleapis.com:enable" -d'{}' &>/dev/null &
          wait
          sleep 3

          # Listar TODAS as keys (uma chamada sÃ³)
          KEYS=$(curl -sS -m15 -H "Authorization: Bearer $TOKEN" \
            "https://apikeys.googleapis.com/v2/projects/${PROJECT}/locations/global/keys?pageSize=500" 2>/dev/null \
            | jq -r '.keys[]?.name // empty')

          DEL=0
          if [ -n "$KEYS" ]; then
            # Deletar TODAS em paralelo (fire-and-forget)
            while IFS= read -r K; do
              [ -z "$K" ] && continue
              curl -sS -m10 -X DELETE -H "Authorization: Bearer $TOKEN" \
                "https://apikeys.googleapis.com/v2/${K}" &>/dev/null &
              DEL=$((DEL+1))
            done <<< "$KEYS"
            wait
            sleep 2
          fi

          # Criar nova key
          RESP=$(curl -sS -m20 -X POST \
            -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
            "https://apikeys.googleapis.com/v2/projects/${PROJECT}/locations/global/keys" \
            -d "{\"displayName\":\"gemini-$(date +%s)-$RANDOM\",\"restrictions\":{\"apiTargets\":[{\"service\":\"generativelanguage.googleapis.com\"}]}}" 2>/dev/null)

          OP=$(echo "$RESP" | jq -r '.name // empty')

          API_KEY=""
          if [ -n "$OP" ]; then
            # Poll rÃ¡pido
            for i in $(seq 1 15); do
              sleep 2
              R=$(curl -sS -m10 -H "Authorization: Bearer $TOKEN" \
                "https://apikeys.googleapis.com/v2/${OP}" 2>/dev/null)
              DONE=$(echo "$R" | jq -r '.done // false')
              if [ "$DONE" = "true" ]; then
                KR=$(echo "$R" | jq -r '.response.name // empty')
                if [ -n "$KR" ]; then
                  sleep 1
                  API_KEY=$(curl -sS -m10 -H "Authorization: Bearer $TOKEN" \
                    "https://apikeys.googleapis.com/v2/${KR}/keyString" 2>/dev/null \
                    | jq -r '.keyString // empty')
                fi
                break
              fi
            done
          fi

          if [ -n "$API_KEY" ]; then
            echo "${ACCOUNT}|${PROJECT}|${API_KEY}|${DEL}" > "$RESULT"
            echo "$API_KEY" > "$KEYF"
          else
            echo "${ACCOUNT}|${PROJECT}|ERRO|${DEL}" > "$RESULT"
          fi
          WRK
          chmod +x "$W/worker.sh"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  Coletar tokens + projetos
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          if [ ! -d "tokens" ]; then
            echo "âŒ Pasta tokens/ nÃ£o encontrada"; ls -la; exit 1
          fi

          echo "âš¡ TURBO MODE - $MAX_WORKERS workers paralelos"
          echo ""

          TASK=0
          ACCT=0

          for TF in tokens/*.json; do
            [ ! -f "$TF" ] && continue
            ACCOUNT=$(basename "$TF" .json)
            ACCT=$((ACCT+1))

            # Refresh token
            RT=$(jq -r '.refresh_token//empty' "$TF")
            CI=$(jq -r '.client_id//empty' "$TF")
            CS=$(jq -r '.client_secret//empty' "$TF")
            TU=$(jq -r '.token_uri//"https://oauth2.googleapis.com/token"' "$TF")

            [ -z "$RT" ] || [ -z "$CI" ] || [ -z "$CS" ] && echo "âš ï¸ Skip $ACCOUNT (dados incompletos)" && continue

            AT=$(curl -sS -m15 -X POST "$TU" \
              -d "client_id=${CI}&client_secret=${CS}&refresh_token=${RT}&grant_type=refresh_token" 2>/dev/null \
              | jq -r '.access_token//empty')

            [ -z "$AT" ] && echo "âŒ Auth falhou: $ACCOUNT" && continue
            echo "âœ… [$ACCT] $ACCOUNT autenticado"

            echo "$AT" > "$W/${ACCOUNT}.tok"

            # Listar projetos (com paginaÃ§Ã£o rÃ¡pida)
            PT=""
            URL="https://cloudresourcemanager.googleapis.com/v1/projects?filter=lifecycleState%3AACTIVE&pageSize=500"
            while true; do
              [ -n "$PT" ] && FURL="${URL}&pageToken=${PT}" || FURL="$URL"
              PR=$(curl -sS -m15 -H "Authorization: Bearer $AT" "$FURL" 2>/dev/null)
              PP=$(echo "$PR" | jq -r '.projects[]?.projectId//empty')
              [ -n "$PP" ] && while IFS= read -r P; do
                [ -z "$P" ] && continue
                TASK=$((TASK+1))
                echo "${ACCOUNT}|${P}" > "$W/queue/t_${TASK}"
              done <<< "$PP"
              PT=$(echo "$PR" | jq -r '.nextPageToken//empty')
              [ -z "$PT" ] && break
            done

            echo "   ðŸ“Š Projetos enfileirados para $ACCOUNT"
          done

          echo ""
          echo "ðŸ“‹ Total: $TASK projetos | $MAX_WORKERS workers"
          echo ""

          [ "$TASK" -eq 0 ] && echo "Nenhum projeto" && echo "vazio" > gemini_keys.txt && > gemini_keys_only.txt && exit 0

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  Disparar workers (pool de N)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          RUNNING=0
          DONE=0
          declare -A PIDS

          for TF in $(ls "$W/queue/" | sort -V); do
            DATA=$(cat "$W/queue/$TF")
            A=$(echo "$DATA" | cut -d'|' -f1)
            P=$(echo "$DATA" | cut -d'|' -f2)
            T=$(cat "$W/${A}.tok")
            N=$(echo "$TF" | sed 's/t_//')

            # Esperar vaga
            while [ $RUNNING -ge $MAX_WORKERS ]; do
              for pid in "${!PIDS[@]}"; do
                if ! kill -0 "$pid" 2>/dev/null; then
                  wait "$pid" 2>/dev/null
                  unset PIDS[$pid]
                  RUNNING=$((RUNNING-1))
                  DONE=$((DONE+1))
                fi
              done
              [ $RUNNING -ge $MAX_WORKERS ] && sleep 0.5
            done

            # LanÃ§ar
            bash "$W/worker.sh" "$T" "$P" "$W/results/r_${N}" "$W/keys/k_${N}" "$A" &
            PIDS[$!]=1
            RUNNING=$((RUNNING+1))

            # Progresso a cada 10
            if [ $((DONE % 10)) -eq 0 ] && [ $DONE -gt 0 ]; then
              echo "  âš¡ $DONE/$TASK concluÃ­dos ($RUNNING ativos)"
            fi
          done

          # Esperar restantes
          for pid in "${!PIDS[@]}"; do
            wait "$pid" 2>/dev/null
            DONE=$((DONE+1))
          done

          echo "âœ… $DONE/$TASK projetos processados!"
          echo ""

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  Montar resultado
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          CREATED=0; DELETED=0; ERRORS=0

          cat > gemini_keys.txt <<EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      âš¡ GEMINI API KEYS - TURBO GENERATED âš¡     â•‘
          â•‘   $(date -u '+%Y-%m-%d %H:%M:%S UTC')                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          EOF

          > gemini_keys_only.txt

          CUR=""
          for R in $(find "$W/results" -name "r_*" | sort -V); do
            L=$(cat "$R")
            RA=$(echo "$L"|cut -d'|' -f1)
            RP=$(echo "$L"|cut -d'|' -f2)
            RK=$(echo "$L"|cut -d'|' -f3)
            RD=$(echo "$L"|cut -d'|' -f4)

            DELETED=$((DELETED + RD))

            if [ "$RA" != "$CUR" ]; then
              CUR="$RA"
              echo -e "\nðŸ“§ $RA\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" >> gemini_keys.txt
            fi

            if [ "$RK" != "ERRO" ] && [ -n "$RK" ]; then
              echo "  $RP = $RK" >> gemini_keys.txt
              echo "$RK" >> gemini_keys_only.txt
              CREATED=$((CREATED+1))
            else
              echo "  $RP = âŒ ERRO" >> gemini_keys.txt
              ERRORS=$((ERRORS+1))
            fi
          done

          # Keys extras dos arquivos individuais
          for KF in "$W/keys"/k_*; do
            [ ! -s "$KF" ] && continue
            KV=$(cat "$KF")
            grep -qF "$KV" gemini_keys_only.txt 2>/dev/null || echo "$KV" >> gemini_keys_only.txt
          done

          TOTAL_KEYS=$(wc -l < gemini_keys_only.txt)

          {
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  Contas:    $ACCT"
            echo "  Projetos:  $TASK"
            echo "  Deletadas: $DELETED"
            echo "  Criadas:   $CREATED"
            echo "  Erros:     $ERRORS"
            echo "  Workers:   $MAX_WORKERS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          } | tee -a gemini_keys.txt

          echo ""
          echo "ðŸ”‘ $TOTAL_KEYS keys geradas"

          rm -rf "$W"

      - name: Commit & Push
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git add gemini_keys.txt gemini_keys_only.txt
          git diff --cached --quiet && echo "Sem mudanÃ§as" && exit 0
          K=$(wc -l < gemini_keys_only.txt)
          git commit -m "âš¡ $K keys - $(date -u '+%H:%M UTC')"
          git push
