name: ðŸŽ¬ Create YouTube Clips

on:
  workflow_dispatch:
    inputs:
      vod_link:
        description: 'ðŸ”— Link do VOD da Twitch'
        required: true
        type: string
      password:
        description: 'ðŸ” Senha para executar'
        required: true
        type: string

env:
  PYTHONUNBUFFERED: "1"

jobs:
  validate:
    name: ðŸ” Validar Senha
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Verificar senha
        id: check
        run: |
          if [ "${{ github.event.inputs.password }}" = "${{ secrets.SENHA }}" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "âœ… Senha vÃ¡lida!"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ Senha invÃ¡lida!"
            exit 1
          fi

  create-clips:
    name: ðŸŽ¬ Processar Clipes
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg xvfb
          
      - name: ðŸ“¦ Instalar dependÃªncias Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: ðŸ“¥ Baixar configuraÃ§Ãµes do repositÃ³rio externo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "ðŸ“¥ Baixando analise_resultado.json..."
          curl -H "Authorization: token $GH_PAT" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o analise_resultado.json \
               "https://api.github.com/repos/Alisson990jd/apiss/contents/analise_resultado.json"
          
          echo "ðŸ“¥ Baixando gmail_token.pkl..."
          curl -H "Authorization: token $GH_PAT" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o gmail_token.pkl \
               "https://api.github.com/repos/Alisson990jd/apiss/contents/gmail_token.pkl"
          
          echo "ðŸ“¥ Baixando arquivos da pasta analisar..."
          mkdir -p analisar
          
          # Listar arquivos na pasta analisar
          FILES=$(curl -s -H "Authorization: token $GH_PAT" \
                       -H "Accept: application/vnd.github.v3+json" \
                       "https://api.github.com/repos/Alisson990jd/apiss/contents/analisar" | \
                  jq -r '.[] | select(.name | endswith(".json")) | .name')
          
          for FILE in $FILES; do
            echo "  ðŸ“„ Baixando $FILE..."
            curl -H "Authorization: token $GH_PAT" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o "analisar/$FILE" \
                 "https://api.github.com/repos/Alisson990jd/apiss/contents/analisar/$FILE"
          done
          
          echo "âœ… ConfiguraÃ§Ãµes baixadas!"
          ls -la
          ls -la analisar/

      - name: ðŸŽ¬ Processar Clipes
        env:
          VOD_LINK: ${{ github.event.inputs.vod_link }}
          DISPLAY: ':99'
        run: |
          # Iniciar Xvfb para Playwright
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          python scripts/clip_creator.py "$VOD_LINK"

      - name: ðŸ“Š Resumo
        if: always()
        run: |
          echo "## ðŸ“Š Resumo do Processamento" >> $GITHUB_STEP_SUMMARY
          if [ -f "processing_log.json" ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat processing_log.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload de logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs
          path: |
            *.log
            processing_log.json
            error_screenshots/
          retention-days: 7
